{% extends 'portfolio/base.html' %}
{% load static %}

{% block title %}Agent Analytics{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

    .glass-effect {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .gradient-text {
        background: linear-gradient(135deg, #6d28d9, #8b5cf6);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    .gradient-border {
        position: relative;
        border-radius: 0.75rem;
        background: linear-gradient(#f8f7ff, #f8f7ff) padding-box,
            linear-gradient(135deg, #6d28d9, #8b5cf6) border-box;
        border: 2px solid transparent;
    }
</style>
{% endblock %}

{% block content %}
{% include "go_back_button.html" %}
<div class="min-h-screen flex flex-col items-center justify-center bg-[#f8f7ff] py-12 px-4">
    <div class="w-full max-w-7xl mx-auto space-y-10">
        <!-- Header -->
        <div class="glass-effect gradient-border rounded-2xl shadow-2xl p-8 text-center">
            <h2 class="text-2xl md:text-3xl font-bold mb-2 gradient-text flex items-center justify-center gap-2">
                <i class="fas fa-chart-line"></i> Analytics Dashboard
            </h2>
            <p class="text-gray-600">Detailed performance insights for {{ user.userprofile.first_name }}</p>
        </div>

        <!-- Date Filter -->
        <div class="glass-effect rounded-2xl shadow p-6">
            <form method="GET" class="flex flex-col md:flex-row gap-4 items-center">
                <div class="flex flex-col md:flex-row gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                        <input type="date" name="from_date" value="{{ from_date }}"
                            class="form-input px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-violet-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                        <input type="date" name="to_date" value="{{ to_date }}"
                            class="form-input px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-violet-500 focus:outline-none">
                    </div>
                </div>
                <button type="submit"
                    class="btn-hover-effect bg-violet-600 hover:bg-violet-700 text-white px-6 py-2 rounded-xl font-medium shadow flex items-center">
                    <i class="fas fa-filter mr-2"></i> Filter
                </button>
                <a href="{% url 'agent_analytics' %}"
                    class="btn-hover-effect bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-xl font-medium shadow flex items-center">
                    <i class="fas fa-times mr-2"></i> Clear
                </a>
            </form>
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="glass-effect rounded-xl shadow p-6 text-center">
                <h3 class="text-3xl font-bold text-violet-700">{{ total_invitations }}</h3>
                <p class="text-gray-600 mt-2">Total Invitations</p>
            </div>
            <div class="glass-effect rounded-xl shadow p-6 text-center">
                <h3 class="text-3xl font-bold text-green-600">{{ approved_invitations }}</h3>
                <p class="text-gray-600 mt-2">Approved Students</p>
            </div>
            <div class="glass-effect rounded-xl shadow p-6 text-center">
                <h3 class="text-3xl font-bold text-blue-600">{{ conversion_rate }}%</h3>
                <p class="text-gray-600 mt-2">Conversion Rate</p>
            </div>
            <div class="glass-effect rounded-xl shadow p-6 text-center">
                <h3 class="text-3xl font-bold text-yellow-500">₹{{ total_payments }}</h3>
                <p class="text-gray-600 mt-2">Total Payments</p>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Monthly Invitations Chart -->
            <div class="glass-effect rounded-2xl shadow p-6">
                <h5 class="font-semibold text-lg mb-4 flex items-center gap-2 text-violet-700">
                    <i class="fas fa-chart-bar"></i> Monthly Student Invitations
                </h5>
                <canvas id="invitationsChart" height="300"></canvas>
            </div>

            <!-- Monthly Payments Chart -->
            <div class="glass-effect rounded-2xl shadow p-6">
                <h5 class="font-semibold text-lg mb-4 flex items-center gap-2 text-green-700">
                    <i class="fas fa-money-bill-wave"></i> Monthly Payments
                </h5>
                <canvas id="paymentsChart" height="300"></canvas>
            </div>
        </div>

        <!-- Performance Insights -->
        <div class="glass-effect rounded-2xl shadow p-6">
            <h5 class="font-semibold text-lg mb-4 flex items-center gap-2 text-blue-700">
                <i class="fas fa-lightbulb"></i> Performance Insights
            </h5>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center p-4 bg-white/80 rounded-xl">
                    <i class="fas fa-clock text-2xl text-blue-500 mb-2"></i>
                    <h6 class="font-semibold">Average Approval Time</h6>
                    <p class="text-gray-600">
                        {% if avg_approval_time %}
                        {{ avg_approval_time|floatformat:1 }} days
                        {% else %}
                        N/A
                        {% endif %}
                    </p>
                </div>
                <div class="text-center p-4 bg-white/80 rounded-xl">
                    <i class="fas fa-percentage text-2xl text-green-500 mb-2"></i>
                    <h6 class="font-semibold">Success Rate</h6>
                    <p class="text-gray-600">{{ conversion_rate }}%</p>
                </div>
                <div class="text-center p-4 bg-white/80 rounded-xl">
                    <i class="fas fa-trending-up text-2xl text-violet-500 mb-2"></i>
                    <h6 class="font-semibold">Growth Trend</h6>
                    <p class="text-gray-600">
                        {% if monthly_invitations|length > 1 %}
                        {% with last_month=monthly_invitations|last %}
                        {% with first_month=monthly_invitations|first %}
                        {% if last_month.count > first_month.count %}
                        <span class="text-green-600">↗ Growing</span>
                        {% else %}
                        <span class="text-red-600">↘ Declining</span>
                        {% endif %}
                        {% endwith %}
                        {% endwith %}
                        {% else %}
                        <span class="text-gray-500">New</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="glass-effect rounded-2xl shadow p-6">
            <h5 class="font-semibold text-lg mb-4 flex items-center gap-2 text-yellow-700">
                <i class="fas fa-star"></i> Recommendations
            </h5>
            <div class="space-y-4">
                {% if conversion_rate < 50 %} <div class="flex items-start gap-3 p-4 bg-yellow-50 rounded-xl">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mt-1"></i>
                    <div>
                        <h6 class="font-semibold text-yellow-800">Low Conversion Rate</h6>
                        <p class="text-yellow-700 text-sm">Your conversion rate is below average. Consider improving
                            your student screening process or providing better support.</p>
                    </div>
            </div>
            {% endif %}

            {% if total_invitations < 10 %} <div class="flex items-start gap-3 p-4 bg-blue-50 rounded-xl">
                <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                <div>
                    <h6 class="font-semibold text-blue-800">Increase Activity</h6>
                    <p class="text-blue-700 text-sm">You have room to grow! Try adding more students to increase your
                        earnings potential.</p>
                </div>
        </div>
        {% endif %}

        {% if conversion_rate >= 80 %}
        <div class="flex items-start gap-3 p-4 bg-green-50 rounded-xl">
            <i class="fas fa-trophy text-green-500 mt-1"></i>
            <div>
                <h6 class="font-semibold text-green-800">Excellent Performance!</h6>
                <p class="text-green-700 text-sm">Your conversion rate is outstanding! Keep up the great work and
                    consider mentoring other agents.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
</div>
</div>

<script>
    // Chart configurations
    const invitationsData = {{ monthly_invitations| safe }};
    const paymentsData = {{ monthly_payments| safe }};

    // Invitations Chart
    const invitationsCtx = document.getElementById('invitationsChart').getContext('2d');
    new Chart(invitationsCtx, {
        type: 'line',
        data: {
            labels: invitationsData.map(item => new Date(item.month).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })),
            datasets: [{
                label: 'Student Invitations',
                data: invitationsData.map(item => item.count),
                borderColor: '#6d28d9',
                backgroundColor: 'rgba(109, 40, 217, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // Payments Chart
    const paymentsCtx = document.getElementById('paymentsChart').getContext('2d');
    new Chart(paymentsCtx, {
        type: 'bar',
        data: {
            labels: paymentsData.map(item => new Date(item.month).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })),
            datasets: [{
                label: 'Payment Amount (₹)',
                data: paymentsData.map(item => item.total_amount),
                backgroundColor: '#10b981',
                borderColor: '#059669',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function (value) {
                            return '₹' + value;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}