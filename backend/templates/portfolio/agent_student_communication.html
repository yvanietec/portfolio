{% extends 'portfolio/base.html' %}
{% load static %}

{% block title %}Student Communication{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

    .glass-effect {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .gradient-text {
        background: linear-gradient(135deg, #6d28d9, #8b5cf6);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    .gradient-border {
        position: relative;
        border-radius: 0.75rem;
        background: linear-gradient(#f8f7ff, #f8f7ff) padding-box,
            linear-gradient(135deg, #6d28d9, #8b5cf6) border-box;
        border: 2px solid transparent;
    }
</style>
{% endblock %}

{% block content %}
{% include "go_back_button.html" %}
<div class="min-h-screen flex flex-col items-center justify-center bg-[#f8f7ff] py-12 px-4">
    <div class="w-full max-w-7xl mx-auto space-y-10">
        <!-- Header -->
        <div class="glass-effect gradient-border rounded-2xl shadow-2xl p-8 text-center">
            <h2 class="text-2xl md:text-3xl font-bold mb-2 gradient-text flex items-center justify-center gap-2">
                <i class="fas fa-comments"></i> Student Communication Center
            </h2>
            <p class="text-gray-600">Manage and communicate with your students</p>
        </div>

        <!-- Overview Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="glass-effect rounded-xl shadow p-6 text-center">
                <h3 class="text-3xl font-bold text-violet-700">{{ total_students }}</h3>
                <p class="text-gray-600 mt-2">Total Students</p>
            </div>
            <div class="glass-effect rounded-xl shadow p-6 text-center">
                <h3 class="text-3xl font-bold text-green-600">{{ active_students_count }}</h3>
                <p class="text-gray-600 mt-2">Active Students</p>
            </div>
            <div class="glass-effect rounded-xl shadow p-6 text-center">
                <h3 class="text-3xl font-bold text-blue-600">{{ portfolios_completed }}</h3>
                <p class="text-gray-600 mt-2">Portfolios Completed</p>
            </div>
            <div class="glass-effect rounded-xl shadow p-6 text-center">
                <h3 class="text-3xl font-bold text-yellow-500">{{ student_portfolios.count }}</h3>
                <p class="text-gray-600 mt-2">Total Portfolios</p>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Student List -->
            <div class="lg:col-span-2">
                <div class="glass-effect rounded-2xl shadow p-6">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6">
                        <h5 class="font-semibold text-lg flex items-center gap-2 text-violet-700">
                            <i class="fas fa-users"></i> Your Students
                        </h5>
                        <div class="flex gap-2 mt-4 md:mt-0">
                            <button id="selectAllBtn"
                                class="btn-hover-effect bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg font-medium shadow flex items-center">
                                <i class="fas fa-check-square mr-2"></i> Select All
                            </button>
                            <button id="sendBulkBtn"
                                class="btn-hover-effect bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium shadow flex items-center"
                                disabled>
                                <i class="fas fa-paper-plane mr-2"></i> Send Message
                            </button>
                        </div>
                    </div>

                    <!-- Student Tabs -->
                    <div class="mb-6">
                        <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                            <button class="tab-btn active px-4 py-2 rounded-md text-sm font-medium" data-tab="active">
                                Active ({{ active_students.count }})
                            </button>
                            <button class="tab-btn px-4 py-2 rounded-md text-sm font-medium" data-tab="approved">
                                Approved ({{ approved_students.count }})
                            </button>
                        </div>
                    </div>

                    <!-- Active Students -->
                    <div id="active-tab" class="tab-content">
                        {% for student in active_students %}
                        <div
                            class="student-card border border-gray-200 rounded-xl p-4 mb-4 hover:bg-violet-50 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <input type="checkbox" class="student-checkbox" value="{{ student.id }}">
                                    <div>
                                        <h6 class="font-semibold">{{ student.student_first_name }} {{
                                            student.student_last_name }}</h6>
                                        <p class="text-gray-600 text-sm">{{ student.student_email }}</p>
                                        <p class="text-gray-500 text-xs">Activated: {{ student.admin_approved_at|date:"M
                                            d, Y" }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span
                                        class="inline-block px-3 py-1 rounded bg-green-100 text-green-700 text-xs font-semibold">Active</span>
                                    <button class="text-blue-600 hover:text-blue-800"
                                        onclick="viewStudentDetails({{ student.id }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 text-center py-8">No active students yet.</p>
                        {% endfor %}
                    </div>

                    <!-- Approved Students -->
                    <div id="approved-tab" class="tab-content hidden">
                        {% for student in approved_students %}
                        <div
                            class="student-card border border-gray-200 rounded-xl p-4 mb-4 hover:bg-violet-50 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <input type="checkbox" class="student-checkbox" value="{{ student.id }}">
                                    <div>
                                        <h6 class="font-semibold">{{ student.student_first_name }} {{
                                            student.student_last_name }}</h6>
                                        <p class="text-gray-600 text-sm">{{ student.student_email }}</p>
                                        <p class="text-gray-500 text-xs">Approved: {{ student.admin_approved_at|date:"M
                                            d, Y" }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span
                                        class="inline-block px-3 py-1 rounded bg-yellow-100 text-yellow-700 text-xs font-semibold">Approved</span>
                                    <button class="text-blue-600 hover:text-blue-800"
                                        onclick="viewStudentDetails({{ student.id }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 text-center py-8">No approved students yet.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Communication Panel -->
            <div class="space-y-6">
                <!-- Bulk Message Form -->
                <div class="glass-effect rounded-2xl shadow p-6">
                    <h5 class="font-semibold text-lg mb-4 flex items-center gap-2 text-green-700">
                        <i class="fas fa-paper-plane"></i> Send Message
                    </h5>
                    <form id="bulkMessageForm">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                            <textarea id="messageText" rows="4"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-violet-500 focus:outline-none"
                                placeholder="Type your message here..."></textarea>
                        </div>
                        <button type="submit"
                            class="w-full btn-hover-effect bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-medium shadow flex items-center justify-center">
                            <i class="fas fa-send mr-2"></i> Send to Selected Students
                        </button>
                    </form>
                </div>

                <!-- Recent Activities -->
                <div class="glass-effect rounded-2xl shadow p-6">
                    <h5 class="font-semibold text-lg mb-4 flex items-center gap-2 text-blue-700">
                        <i class="fas fa-clock"></i> Recent Activities
                    </h5>
                    <div class="space-y-3">
                        {% for activity in recent_activities %}
                        <div class="flex items-start space-x-3 p-3 bg-white/80 rounded-lg">
                            <i class="fas fa-user-edit text-blue-500 mt-1"></i>
                            <div class="flex-1">
                                <p class="text-sm font-medium">{{ activity.student.first_name }} {{
                                    activity.student.last_name }}</p>
                                <p class="text-xs text-gray-600">{{ activity.message }}</p>
                                <p class="text-xs text-gray-500">{{ activity.timestamp|date:"M d, H:i" }}</p>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 text-center py-4">No recent activities</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="glass-effect rounded-2xl shadow p-6">
                    <h5 class="font-semibold text-lg mb-4 flex items-center gap-2 text-violet-700">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </h5>
                    <div class="space-y-3">
                        <button
                            class="w-full btn-hover-effect bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg font-medium shadow flex items-center justify-center">
                            <i class="fas fa-download mr-2"></i> Export Student List
                        </button>
                        <button
                            class="w-full btn-hover-effect bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-4 py-2 rounded-lg font-medium shadow flex items-center justify-center">
                            <i class="fas fa-chart-bar mr-2"></i> View Analytics
                        </button>
                        <a href="{% url 'agent_add_student' %}"
                            class="w-full btn-hover-effect bg-violet-600 hover:bg-violet-700 text-white px-4 py-2 rounded-lg font-medium shadow flex items-center justify-center">
                            <i class="fas fa-user-plus mr-2"></i> Add New Student
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Details Modal -->
<div id="studentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-lg font-semibold">Student Details</h3>
                <button onclick="closeStudentModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="studentModalContent" class="p-6">
                <!-- Student details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
    // Tab functionality
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            // Add active class to clicked tab
            button.classList.add('active');
            const tabId = button.getAttribute('data-tab') + '-tab';
            document.getElementById(tabId).classList.remove('hidden');
        });
    });

    // Checkbox functionality
    document.getElementById('selectAllBtn').addEventListener('click', function () {
        const checkboxes = document.querySelectorAll('.student-checkbox:not(:disabled)');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);

        checkboxes.forEach(checkbox => {
            checkbox.checked = !allChecked;
        });

        updateSendButton();
    });

    document.querySelectorAll('.student-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSendButton);
    });

    function updateSendButton() {
        const checkedBoxes = document.querySelectorAll('.student-checkbox:checked');
        const sendBtn = document.getElementById('sendBulkBtn');

        if (checkedBoxes.length > 0) {
            sendBtn.disabled = false;
            sendBtn.textContent = `Send Message (${checkedBoxes.length})`;
        } else {
            sendBtn.disabled = true;
            sendBtn.textContent = 'Send Message';
        }
    }

    // Bulk message form
    document.getElementById('bulkMessageForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const message = document.getElementById('messageText').value.trim();
        const checkedBoxes = document.querySelectorAll('.student-checkbox:checked');

        if (!message) {
            alert('Please enter a message');
            return;
        }

        if (checkedBoxes.length === 0) {
            alert('Please select at least one student');
            return;
        }

        const studentIds = Array.from(checkedBoxes).map(cb => cb.value);

        if (confirm(`Send message to ${studentIds.length} student(s)?`)) {
            // Send the message
            fetch('{% url "agent_send_bulk_message" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: new URLSearchParams({
                    'message': message,
                    'student_ids': studentIds
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        document.getElementById('messageText').value = '';
                        document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
                        updateSendButton();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while sending the message');
                });
        }
    });

    function viewStudentDetails(studentId) {
        // This would typically fetch student details from the server
        // For now, we'll show a placeholder
        const modal = document.getElementById('studentModal');
        const content = document.getElementById('studentModalContent');

        content.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-user-circle text-6xl text-gray-400 mb-4"></i>
                <h4 class="text-lg font-semibold mb-2">Student Details</h4>
                <p class="text-gray-600">Loading student information...</p>
            </div>
        `;

        modal.classList.remove('hidden');
    }

    function closeStudentModal() {
        document.getElementById('studentModal').classList.add('hidden');
    }

    // Close modal when clicking outside
    document.getElementById('studentModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeStudentModal();
        }
    });
</script>
{% endblock %}